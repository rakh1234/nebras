<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¨Ø±Ø§Ø³ â€” Emergency Home Card (Demo)</title>
<style>
  :root{--accent:#0B72FF;--success:#28a745;--bg:#f6f8fb;--card:#fff;}
  body{font-family:Inter, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#222; margin:0; padding:24px; direction: rtl}
  .container{max-width:900px;margin:0 auto}
  header{display:flex;gap:16px;align-items:center}
  .logo{width:68px;height:68px;border-radius:12px;background:linear-gradient(135deg,#0B72FF,#6BB7FF);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px}
  h1{margin:0;font-size:20px}
  .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(11, 114, 255, .06);margin-top:18px}
  .controls{display:flex;gap:12px;flex-wrap:wrap}
  button{background:var(--accent);color:white;border:0;padding:10px 16px;border-radius:10px;cursor:pointer}
  .secondary{background:#eee;color:#333}
  .info-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #eee}
  .muted{color:#666;font-size:13px}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f8ff;color:var(--accent);font-weight:600}
  .danger{color:#c0392b;font-weight:700}
  .status{display:flex;gap:10px;align-items:center}
  .qr{width:120px;height:120px;background:#fff;border:1px solid #ddd;display:flex;align-items:center;justify-content:center;color:#aaa}
  pre{background:#0f1724;color:#f8fafc;padding:12px;border-radius:8px;overflow:auto;font-size:13px}
  footer{margin-top:18px;color:#666;font-size:13px}
  .field{font-weight:700}
  .value{font-weight:600}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">NB</div>
    <div>
      <h1>Ù†Ø¨Ø±Ø§Ø³ â€” Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ù†Ù‚Ø§Ø° Ø§Ù„Ø°ÙƒÙŠØ© (Ø¹Ø±Ø¶ ØªØ¬Ø±ÙŠØ¨ÙŠ)</h1>
      <div class="muted">Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø±Ø¬Ø§Ù„ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø¨Ø¹Ø¯ Ù…Ø³Ø­ Ø§Ù„Ø´Ø±ÙŠØ­Ø©/QR</div>
    </div>
  </header>

  <div class="card" id="mainCard">
    <div class="controls">
      <button id="btnScan">Ù…Ø³Ø­ NFC (Ù…Ø­Ø§ÙƒØ§Ø©)</button>
      <button id="btnQR" class="secondary">QR Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
      <button id="btnAuth" class="secondary">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØªØµØ±ÙŠØ­ (Ù…Ø­Ø§ÙƒØ§Ø©)</button>
      <div style="margin-left:auto" class="badge" id="houseId">NB-0001</div>
    </div>

    <div id="status" style="margin-top:14px" class="muted">Ø§Ø¶ØºØ· Â«Ù…Ø³Ø­ NFCÂ» Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…Ø³Ø­.</div>

    <div id="profile" style="display:none;margin-top:14px">
      <div class="info-row"><div><span class="field">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø²Ù„</span></div><div class="value" id="occupied">â€”</div></div>
      <div class="info-row"><div><span class="field">Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†</span></div><div class="value" id="people">â€”</div></div>
      <div class="info-row"><div><span class="field">Ø£Ø·ÙØ§Ù„</span></div><div class="value" id="kids">â€”</div></div>
      <div class="info-row"><div><span class="field">ÙƒØ¨Ø§Ø± Ø³Ù†</span></div><div class="value" id="elders">â€”</div></div>
      <div class="info-row"><div><span class="field">Ø­Ø§Ù„Ø§Øª Ø·Ø¨ÙŠØ©</span></div><div class="value" id="medical">â€”</div></div>
      <div class="info-row"><div><span class="field">Ù…ØµØ§Ø¯Ø± Ø®Ø·Ø±</span></div><div class="value danger" id="hazards">â€”</div></div>

      <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
        <button id="call911">ğŸ“ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</button>
        <button id="toggleEmergency" class="secondary">Ø±ÙØ¹ Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦ (Ù…Ø­Ø§ÙƒØ§Ø©)</button>
        <div style="margin-left:auto" class="muted">Ø§Ù„Ù…ØµØ¯Ø±: <strong>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠ</strong></div>
      </div>

      <div style="margin-top:14px">
        <div class="muted">ØªÙØ§ØµÙŠÙ„ Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„:</div>
        <div class="info-row"><div class="field">Ø±Ù‚Ù…</div><div class="value" id="phone">â€”</div></div>
      </div>

      <h3 style="margin-top:14px">Ø³Ø¬Ù„ Ø§Ù„ÙˆØµÙˆÙ„ (Ù…Ø­Ø§ÙƒØ§Ø©)</h3>
      <pre id="log">â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯ â€”</pre>
    </div>

    <div id="noAccess" style="display:none;margin-top:12px" class="muted">
      â— Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª â€” ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ù…Ø±Ø®Ù‘Øµ.
    </div>

  </div>

  <footer>Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© ØªØ¹Ø±Ø¶ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„: Ø§Ù„Ø·Ù„Ø¨ ÙŠÙ†Ø¬Ø­ ÙÙ‚Ø· Ø¥Ø°Ø§ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ "ØªÙˆÙƒÙ†" Ù…ØµØ¯Ù‘Ù‚ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….</footer>
</div>

<script>
  const houseId = 'NB-0001';            // Ø«Ø§Ø¨Øª Ù„Ù„Ø¹Ø±Ø¶
  let authToken = null;

  function log(msg){
    const pre = document.getElementById('log');
    const now = new Date().toLocaleTimeString();
    pre.textContent = `${now} â€” ${msg}\n` + pre.textContent;
  }

  async function requestToken(){
    log('Ø·Ù„Ø¨ ØªØµØ±ÙŠØ­...');
    const res = await fetch('/auth', { method: 'POST' });
    if(!res.ok){ log('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØµØ±ÙŠØ­'); return null; }
    const j = await res.json();
    authToken = j.token;
    log('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªØµØ±ÙŠØ­ (Ù…Ø­Ø§ÙƒØ§Ø©).');
    document.getElementById('status').textContent = 'ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØµØ±ÙŠØ­ Ù…Ø¤Ù‚Øª. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ù…Ø³Ø­.';
    return authToken;
  }

  async function fetchProfile(id){
    document.getElementById('status').textContent = 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„...';
    // Attach token as header to simulate restricted access
    const headers = authToken ? { 'Authorization': 'Bearer ' + authToken } : {};
    const res = await fetch(`/api/house/${id}`, { headers });
    if(res.status === 403){
      document.getElementById('profile').style.display='none';
      document.getElementById('noAccess').style.display='block';
      document.getElementById('status').textContent = 'Ù…Ø­Ø¸ÙˆØ±: Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…Ø±Ø®Ù‘Øµ';
      log('ØªÙ… Ø±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„ â€” Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…Ø±Ø®Ù‘Øµ.');
      return;
    }
    const data = await res.json();
    document.getElementById('noAccess').style.display='none';
    document.getElementById('profile').style.display='block';
    document.getElementById('occupied').textContent = data.occupied ? 'Ù…Ø£Ù‡ÙˆÙ„' : 'Ø®Ø§Ù„ÙŠ';
    document.getElementById('people').textContent = data.count;
    document.getElementById('kids').textContent = data.children;
    document.getElementById('elders').textContent = data.elders;
    document.getElementById('medical').textContent = data.medical || 'Ù„Ø§';
    document.getElementById('hazards').textContent = data.hazards.join(', ') || 'Ù„Ø§';
    document.getElementById('phone').textContent = data.contact_number;
    document.getElementById('status').textContent = 'ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­';
    log('ØªÙ… Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ Ø¨Ù†Ø¬Ø§Ø­.');
  }

  document.getElementById('btnAuth').addEventListener('click', async () => {
    await requestToken();
  });

  // Simulate NFC scan: opens the house profile with token header
  document.getElementById('btnScan').addEventListener('click', async () => {
    document.getElementById('status').textContent = 'Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø³Ø­ NFC...';
    log('Ù…Ø­Ø§ÙƒØ§Ø©: Ù…Ø³Ø­ Ø¨Ø·Ø§Ù‚Ø© NFC.');
    // In real life the NFC payload would include an ID + signature; we simulate by calling fetch
    await fetchProfile(houseId);
  });

  // QR fallback: show QR code (simulated) with direct link
  document.getElementById('btnQR').addEventListener('click', () => {
    alert('QR Ø§Ø­ØªÙŠØ§Ø·ÙŠ: https://demo.local/scan/NB-0001 (Ù…Ø­Ø§ÙƒØ§Ø©)');
    log('Ø¹Ø±Ø¶ QR Ø§Ø­ØªÙŠØ§Ø·ÙŠ.');
  });

  document.getElementById('call911').addEventListener('click', () => {
    log('Ù…Ø­Ø§ÙƒØ§Ø©: Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ (911).');
    alert('Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ (Ù…Ø­Ø§ÙƒØ§Ø©)');
  });

  document.getElementById('toggleEmergency').addEventListener('click', async () => {
    log('Ø±ÙØ¹ ÙˆØ¶Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ (Ù…Ø­Ø§ÙƒØ§Ø©) Ù„Ù„Ø¬Ù‡Ø§Øª.');
    alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ (Ù…Ø­Ø§ÙƒØ§Ø©)');
  });

</script>
</body>
</html>
